<!DOCTYPE html>
<html>

<head>
    <title>PTZOptics Moondream Tracker</title>

    <meta name="viewport" content="width=640, user-scalable=no" />
    <meta charset="UTF-8" />

    <!-- jQuery for DOM manipulation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"
        integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg=="
        crossorigin="anonymous"></script>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="./main.css">
    <link rel="stylesheet" href="../shared/styles.css">
    
    <!-- Application Scripts -->
    <script src="./moondream.js"></script>
    <script src="./ptz_control.js"></script>
    <script src="../shared/api-key-manager.js"></script>
    <script src="../shared/reasoning-console.js"></script>
    <script src="../shared/video-source-adapter.js"></script>
    <script src="./app.js"></script>
</head>

<body>
    <video id="video" autoplay muted playsinline></video>
    
    <!-- Control Panel -->
    <div id="controlPanel">
        <h2>PTZOptics Moondream Tracker</h2>
        
        <div class="control-group">
            <label for="webcamSelect">Video Source:</label>
            <div style="display: flex; gap: 8px;">
                <select id="webcamSelect" class="settings-input" style="flex: 1;">
                    <option value="">Loading cameras...</option>
                </select>
                <button type="button" id="refreshCamerasBtn" class="btn" style="padding: 8px 12px;">üîÑ</button>
            </div>
            <small>Select which webcam to use for tracking</small>
        </div>
        
        <div class="control-group">
            <label for="targetObject">Target Object:</label>
            <input type="text" id="targetObject" class="settings-input" placeholder="e.g., person, ball, hand" />
            <small>Describe what you want to track (e.g., "person", "red ball", "coffee mug")</small>
        </div>
        
        <div class="control-group">
            <label for="cameraIP">PTZ Camera IP:</label>
            <input type="text" id="cameraIP" class="settings-input" placeholder="192.168.1.19" />
        </div>
        
        <div class="control-group">
            <label for="operationStyle">Camera Operation Style:</label>
            <select id="operationStyle" class="settings-input">
                <option value="custom">Custom (Manual Settings)</option>
                <option value="smooth">Smooth Tracking (Broadcast)</option>
                <option value="precise">Precise Centering (Presentation)</option>
                <option value="balanced" selected>Balanced (General Use)</option>
                <option value="fast">Fast Response (Sports/Action)</option>
                <option value="minimal">Minimal Movement (Save API)</option>
            </select>
            <small>Presets adjust speed, deadzone, and detection rate</small>
        </div>
        
        <div class="control-group">
            <label for="detectionRate">Detection Rate: <span id="detectionRateValue">1.0</span> per second</label>
            <input type="range" id="detectionRate" class="slider" min="0.1" max="5" step="0.1" value="1" />
            <div class="slider-labels">
                <small>0.1/sec (Slower)</small>
                <small>5/sec (Faster)</small>
            </div>
            <small class="rate-info">Lower = Less API usage, Higher = More responsive tracking</small>
        </div>
        
        <!-- Advanced PTZ Settings -->
        <div class="advanced-section">
            <button type="button" id="toggleAdvanced" class="toggle-btn">‚öôÔ∏è Advanced PTZ Settings</button>
            <div id="advancedSettings" class="advanced-content" style="display: none;">
                
                <h3 class="section-heading">Movement Speed</h3>
                <div class="settings-row">
                    <div class="control-group half">
                        <label for="panSpeed">Pan Speed: <span id="panSpeedValue">5</span></label>
                        <input type="range" id="panSpeed" class="slider settings-input" min="1" max="10" step="1" value="5" />
                    </div>
                    <div class="control-group half">
                        <label for="tiltSpeed">Tilt Speed: <span id="tiltSpeedValue">5</span></label>
                        <input type="range" id="tiltSpeed" class="slider settings-input" min="1" max="10" step="1" value="5" />
                    </div>
                </div>
                
                <h3 class="section-heading">Center Target Position</h3>
                <div class="settings-row">
                    <div class="control-group half">
                        <label for="centerOffsetX">Horizontal: <span id="centerOffsetXValue">50</span>%</label>
                        <input type="range" id="centerOffsetX" class="slider settings-input" min="30" max="70" step="1" value="50" />
                        <small>Where to center horizontally</small>
                    </div>
                    <div class="control-group half">
                        <label for="centerOffsetY">Vertical: <span id="centerOffsetYValue">50</span>%</label>
                        <input type="range" id="centerOffsetY" class="slider settings-input" min="30" max="70" step="1" value="50" />
                        <small>Where to center vertically</small>
                    </div>
                </div>
                
                <h3 class="section-heading">Centering Precision</h3>
                <div class="settings-row">
                    <div class="control-group half">
                        <label for="deadzoneX">Horizontal Deadzone: <span id="deadzoneXValue">5</span>%</label>
                        <input type="range" id="deadzoneX" class="slider settings-input" min="1" max="50" step="1" value="5" />
                        <small>Smaller = tighter centering</small>
                    </div>
                    <div class="control-group half">
                        <label for="deadzoneY">Vertical Deadzone: <span id="deadzoneYValue">5</span>%</label>
                        <input type="range" id="deadzoneY" class="slider settings-input" min="1" max="50" step="1" value="5" />
                        <small>Smaller = tighter centering</small>
                    </div>
                </div>
                <small class="help-text">
                    <strong>Tip:</strong> Set center target to where you want the object (50% = true center). 
                    Use smaller deadzone (1-5%) for precise centering, larger (15-30%) for smoother tracking.
                </small>
                
            </div>
        </div>
        
        <div class="control-buttons">
            <button id="startBtn" class="btn btn-start">Start Tracking</button>
            <button id="stopBtn" class="btn btn-stop" disabled>Stop Tracking</button>
        </div>
        
        <div id="status" class="status-message">Initializing...</div>
        
        <!-- Manual PTZ Controls -->
        <div class="manual-ptz-section">
            <h3 class="section-heading">Manual PTZ Controls</h3>
            <div class="ptz-controls-grid">
                <div class="ptz-dpad">
                    <button id="ptzUp" class="ptz-btn ptz-up" title="Tilt Up">‚ñ≤</button>
                    <button id="ptzLeft" class="ptz-btn ptz-left" title="Pan Left">‚óÄ</button>
                    <button id="ptzHome" class="ptz-btn ptz-home" title="Home Position">‚åÇ</button>
                    <button id="ptzRight" class="ptz-btn ptz-right" title="Pan Right">‚ñ∂</button>
                    <button id="ptzDown" class="ptz-btn ptz-down" title="Tilt Down">‚ñº</button>
                </div>
                <div class="zoom-controls">
                    <button id="ptzZoomIn" class="ptz-btn ptz-zoom" title="Zoom In">+</button>
                    <span class="zoom-label">Zoom</span>
                    <button id="ptzZoomOut" class="ptz-btn ptz-zoom" title="Zoom Out">‚àí</button>
                </div>
            </div>
            <small>Hold buttons to move camera. Release to stop.</small>
        </div>
        
        <!-- Performance Note -->
        <div class="performance-note">
            <h3 class="section-heading">‚ö° Performance Tip</h3>
            <p>The Moondream cloud API processes ~1-2 frames/second. For smoother tracking (5-10+ fps), run Moondream locally:</p>
            <ol>
                <li>Install: <code>pip install moondream</code></li>
                <li>Run: <code>moondream serve --host 0.0.0.0 --port 3475</code></li>
                <li>Use local endpoint in API settings</li>
            </ol>
            <a href="https://github.com/vikhyat/moondream" target="_blank" class="docs-link">View Moondream Documentation ‚Üí</a>
        </div>
    </div>
    
    <!-- FPS Counter -->
    <div id="fps"></div>
    <script src="../shared/ux-utils.js"></script>
    <script src="../shared/playground-header.js"></script>
</body>

</html>
